const{cmd:e}=require("../command"),{execFileSync:r}=require("child_process"),fs=require("fs"),path=require("path"),playdl=require("play-dl"),PYTHON_PATH="win32"===process.platform?"python":"python3",PYTHON_SCRIPT=path.join(__dirname,"../lib/ytdl.py"),cleanFilename=e=>e.replace(/[^a-zA-Z0-9_-]/g,"_"),downloadMedia=async e=>{try{let t=[PYTHON_SCRIPT,e],a=r(PYTHON_PATH,t,{maxBuffer:209715200}).toString().trim();console.log(`Raw Python output: ${a}`);let n;try{n=JSON.parse(a)}catch(o){console.error(`JSON parse error: ${o.message}`);let i=a.match(/\/root\/GARFIELD-WHATSAPP-BOT-v10\/lib\/store\/[^\s]+\.mp4/)?.[0];if(i&&fs.existsSync(i))return console.log(`File found despite JSON error: ${i}`),{success:!0,filename:i,title:"Unknown (JSON parse failed)",duration:0};return{success:!1,error:`Invalid JSON output: ${a}`}}return n}catch(s){return console.error("Python execution error:",s),{success:!1,error:`Python execution failed: ${s.message}`}}},searchVideo=async e=>{try{let r=await playdl.search(e,{limit:5});return r[0]}catch(t){return console.error("Search error:",t),null}};e({pattern:"video",react:"\uD83C\uDFA5",desc:"Download YouTube video as 360p mp4",category:"main",use:".video <query>",filename:__filename},async(e,r,t,{from:a,args:n,reply:o})=>{try{let i=n.join(" ");if(!i)return o("Please provide a search query");let s=await searchVideo(i);if(!s)return o("No results found");let l=`*ğŸ¬ Video Title* - ${s.title}
*ğŸ•œ Duration* - ${s.durationRaw}
*ğŸ‘ï¸ Views* - ${s.views?.toLocaleString()||"N/A"}
*ğŸ‘¤ Author* - ${s.channel?.name||"Unknown"}
`,c=await downloadMedia(`https://youtu.be/${s.id}`);if(!c.success)return o(`âŒ Download failed: ${c.error}`);let d=fs.statSync(c.filename);if(0===d.size)return fs.unlinkSync(c.filename),o("âŒ Downloaded file is empty");await e.sendMessage(a,{video:fs.readFileSync(c.filename),caption:l,mimetype:"video/mp4"},{quoted:r}),fs.unlinkSync(c.filename)}catch(u){console.error(u),o("âŒ An error occurred while processing the video")}}),module.exports={downloadMedia,searchVideo};
