const{cmd:e}=require("../command"),ytdl=require("@distube/ytdl-core"),playdl=require("play-dl"),fs=require("fs"),path=require("path"),ffmpeg=require("fluent-ffmpeg"),storeDir="./store",cookies=[{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"YSC",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"y3J2I4ug7_Y"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"VISITOR_INFO1_LIVE",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"23fLZJsdyko"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"VISITOR_PRIVACY_METADATA",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"CgJTRxIEGgAgYg%3D%3D"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"PREF",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"tz=Asia.Colombo"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-1PSIDTS",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"sidts-CjIB7pHptT6ynkkbQXBB356bDAaOriEsmD956xf_2vHr-JcQOQbTWpb8KVsEOk06swPOuBAA"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-3PSIDTS",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"sidts-CjIB7pHptT6ynkkbQXBB356bDAaOriEsmD956xf_2vHr-JcQOQbTWpb8KVsEOk06swPOuBAA"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"HSID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"Aniy9moFdgwAbwxhX"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"SSID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"AOg1LQ_s6ntw10z_Z"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"APISID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"CvDxwK2BItUN-tzF/AuAXNKzT-xawmDzkr"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"SAPISID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"0gUDI6X8EmM3hVCQ/AIYKsf_mXQbuii33D"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-1PAPISID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"0gUDI6X8EmM3hVCQ/AIYKsf_mXQbuii33D"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-3PAPISID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"0gUDI6X8EmM3hVCQ/AIYKsf_mXQbuii33D"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"SID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"g.a000vQhqA8tVsc04y5PE0GMxExNyfgXq_m0_c1Ls5wD9MUImO_Spf5ujzjfbNmvHhCgoMBDrRQACgYKAfkSARASFQHGX2MiPlbWPNWVwhe6pjbzYIjwshoVAUF8yKpov3-JaFWc1qiTukHtQYzm0076"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-1PSID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"g.a000vQhqA8tVsc04y5PE0GMxExNyfgXq_m0_c1Ls5wD9MUImO_SprZyHJbhxnN_8dLRD5XAHpgACgYKATcSARASFQHGX2MiH3bMYpm0n3Zdt8WVGOivmxoVAUF8yKpGMEJwoIRbUdZcUuFprUMq0076"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-3PSID",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"g.a000vQhqA8tVsc04y5PE0GMxExNyfgXq_m0_c1Ls5wD9MUImO_Sp15ZHmt6cN6TQnilPhMWTgwACgYKATsSARASFQHGX2Mi6VpMNVdKtVF-tanfhe3aYBoVAUF8yKq0EqaR5MEyL34UgLqeT7IY0076"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"LOGIN_INFO",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"AFmmF2swRAIgBqcuJdssqOxuxg1q7aAdYMiL9t9Ty2f5Fk--YU6VPT0CIC2axghJpTkIXImas4PDBGqto0RbkXw27E6S_Xm-9nUe:QUQ3MjNmdzRkWlFveUFKb0gzUTQzZURKWlhHR3VnRko5dnYzMXk2dWM4dm9kTFhCOFhoeXVhVnFRM2tvZlA2MHJ3UHhNVWltN2JlZ3lLbTM5dG1NNVhYcWxTQXNPSXVBcGdhWFh3R3hkNWo0MzdMcUV3Qm1idFkwMTlfRWw5clRpdkVpeUtVT3dWVTR3UWxBcG1rYTZBSjlaaDkzNFRsODZ3"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-ROLLOUT_TOKEN",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"CMjptNCdkZS38wEQ3qrKy42sjAMY1JSusdS0jAM%3D"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"SIDCC",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"AKEyXzX2dxOP53iE1zIP2PtYbjrKWH8TLrkrG6TeUoyR2rBMzUJTLxUVTFNEds1H6lpskglfLQ"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-1PSIDCC",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"AKEyXzV-c3sCnWchLEerjPm-rhy-yot16Dnn_-bA_NXEeMCqu8ce51FwLmNdzTb43oxP26qd"},{domain:".youtube.com",hostOnly:!1,httpOnly:!0,name:"__Secure-3PSIDCC",path:"/",sameSite:"no_restriction",secure:!0,session:!1,value:"AKEyXzWMHHKMs2nLl6LrOnZGsXhlen5F12FEdjofwKWPBDiRHvRRi-gMPq2CBWoRMtYOSGE4"}],agent=ytdl.createAgent(cookies),ytdlOptions={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9"},agent:agent},handleErrors=(e,t)=>o=>{console.error(o),e(t)},searchVideo=async e=>{try{let t=await playdl.search(e,{limit:1});return t[0]}catch(o){return console.error("Error searching for video:",o),null}},downloadAndConvertAudio=async(e,t,o,n,s,a)=>{try{let i=t.replace(/[^a-zA-Z0-9]/g,"_"),r=path.join(storeDir,`${i}.mp4`),m=path.join(storeDir,`${i}.m4a`),u=await ytdl.getInfo(e,ytdlOptions),c=u.formats.find(e=>18===e.itag);if(!c)return o("❌ No suitable video format found for the specified itag. \uD83D\uDE22");let l=ytdl.downloadFromInfo(u,{format:c,...ytdlOptions});await new Promise((e,t)=>{l.pipe(fs.createWriteStream(r)).on("finish",e).on("error",t)}),await new Promise((e,t)=>{ffmpeg(r).output(m).audioCodec("copy").noVideo().on("end",()=>{console.log("Audio conversion finished"),e()}).on("error",e=>{console.error("FFmpeg error:",e),t(e)}).run()}),await n.sendMessage(s,{document:fs.readFileSync(m),mimetype:"audio/mp4",fileName:`${t}.m4a`},{quoted:a}),fs.unlinkSync(r),fs.unlinkSync(m)}catch(y){handleErrors(o,"❌ An error occurred while processing your request. \uD83D\uDE22")(y)}};e({pattern:"play",react:"\uD83C\uDFB6",desc:"Download YouTube audio by searching for keywords.",category:"main",use:".song <song name or keywords>",filename:__filename},async(e,t,o,{from:n,args:s,reply:a})=>{try{let i=s.join(" ");if(!i)return a("❗️ Please provide a song name or keywords. \uD83D\uDCDD\nExample: .play Despacito");let r=await searchVideo(i);if(await a(`_Downloading...._
*${r.title}*
High Quality From Using *Youtube Music*`),!r)return a(`❌ No results found for "${i}".`);let m=`https://www.youtube.com/watch?v=${r.id}`;await downloadAndConvertAudio(m,r.title,a,e,n,t)}catch(u){handleErrors(a,"❌ An error occurred while processing your request. \uD83D\uDE22")(u)}});
