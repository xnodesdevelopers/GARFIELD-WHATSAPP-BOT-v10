const{cmd:e}=require("../command"),{execFileSync:a}=require("child_process"),fs=require("fs"),path=require("path"),playdl=require("play-dl"),PYTHON_PATH="win32"===process.platform?"python":"python3",PYTHON_SCRIPT=path.join(__dirname,"../lib/ytdl.py"),cleanFilename=e=>e.replace(/[^a-zA-Z0-9_-]/g,"_"),downloadMedia=async(e,r)=>{try{let n=[PYTHON_SCRIPT,e,r],t=a(PYTHON_PATH,n,{maxBuffer:52428800}).toString().trim();console.log(`Raw Python output: ${t}`);let i;try{i=JSON.parse(t)}catch(o){console.error(`JSON parse error: ${o.message}`);let s=t.match(/\/root\/GARFIELD-WHATSAPP-BOT-v10\/lib\/store\/[^\s]+\.(m4a|mp4)/)?.[0];if(s&&fs.existsSync(s))return console.log(`File found despite JSON error: ${s}`),{success:!0,filename:s,title:"Unknown (JSON parse failed)",duration:0};return{success:!1,error:`Invalid JSON output: ${t}`}}return i}catch(l){return console.error("Python execution error:",l),{success:!1,error:`Python execution failed: ${l.message}`}}},searchVideo=async e=>{try{let a=await playdl.search(e,{limit:5});return a[0]}catch(r){return console.error("Search error:",r),null}};e({pattern:"song",react:"\uD83C\uDFB6",desc:"Download YouTube audio as m4a",category:"main",use:".song <query>",filename:__filename},async(e,a,r,{from:n,args:t,reply:i})=>{try{let o=t.join(" ");if(!o)return i("Please provide a search query");let s=await searchVideo(o);if(!s)return i("No results found");let l=`*ğŸ¶ Song Name* - ${s.title}
*ğŸ•œ Duration* - ${s.durationRaw}
*ğŸ“» Listeners* - ${s.views?.toLocaleString()||"N/A"}
*ğŸ™ï¸ Artist* - ${s.channel?.name||"Unknown"}
> File Name ${s.title}.m4a`;await e.sendMessage(n,{image:{url:s.thumbnails[0].url},caption:l});let d=await downloadMedia(`https://youtu.be/${s.id}`,"audio");if(!d.success)return i(`âŒ Download failed: ${d.error}`);let c=fs.statSync(d.filename);if(0===c.size)return fs.unlinkSync(d.filename),i("âŒ Downloaded file is empty");await e.sendMessage(n,{audio:fs.readFileSync(d.filename),mimetype:"audio/mp4",fileName:`${cleanFilename(d.title)}.m4a`},{quoted:a}),fs.unlinkSync(d.filename)}catch(u){console.error(u),i("âŒ An error occurred while processing the audio")}}),e({pattern:"video",react:"\uD83C\uDFA5",desc:"Download YouTube video as 360p mp4",category:"main",use:".video <query>",filename:__filename},async(e,a,r,{from:n,args:t,reply:i})=>{try{let o=t.join(" ");if(!o)return i("Please provide a search query");let s=await searchVideo(o);if(!s)return i("No results found");let l=`*ğŸ¬ Video Title* - ${s.title}
*ğŸ•œ Duration* - ${s.durationRaw}
*ğŸ‘ï¸ Views* - ${s.views?.toLocaleString()||"N/A"}
*ğŸ‘¤ Author* - ${s.channel?.name||"Unknown"}
`,d=await downloadMedia(`https://youtu.be/${s.id}`,"video");if(!d.success)return i(`âŒ Download failed: ${d.error}`);let c=fs.statSync(d.filename);if(0===c.size)return fs.unlinkSync(d.filename),i("âŒ Downloaded file is empty");await e.sendMessage(n,{video:fs.readFileSync(d.filename),caption:l,mimetype:"video/mp4"},{quoted:a}),fs.unlinkSync(d.filename)}catch(u){console.error(u),i("âŒ An error occurred while processing the video")}}),module.exports={downloadMedia,searchVideo};
